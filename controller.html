<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Coyote Controller</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 2rem;
      }
      button {
        margin: 0.5rem;
        padding: 1rem 2rem;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <h1>🕹️ Coyote Controller</h1>
    <p>Verbindung wird aufgebaut...</p>
    <div id="status"></div>
    <div id="buttons" style="margin-top: 2rem"></div>

    <script>
      const socketURL = "wss://coyote-ws-server.onrender.com";
      const connectionId = crypto.randomUUID();
      let targetId = null;
      const ws = new WebSocket(socketURL);

      const statusDiv = document.getElementById("status");
      const buttonsDiv = document.getElementById("buttons");

      function sendBind() {
        const bindMsg = {
          type: "bind",
          message: "DGLAB",
          clientId: connectionId,
          targetId: "", // Wird von der App gesetzt
        };
        ws.send(JSON.stringify(bindMsg));
      }

      function sendStrength(level) {
        if (!targetId) {
          alert("Noch keine App verbunden!");
          return;
        }
        const msg = {
          type: "msg",
          clientId: connectionId,
          targetId: targetId,
          message: `strength-0+0+${level}+${level}`,
        };
        ws.send(JSON.stringify(msg));
      }

      ws.onopen = () => {
        statusDiv.innerHTML = `✅ Verbunden mit Server<br>ID: <code>${connectionId}</code>`;
        sendBind();
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        console.log("📩 Nachricht erhalten:", msg);

        if (msg.type === "bind" && msg.message === "200") {
          targetId = msg.targetId;
          statusDiv.innerHTML += `<br>🔗 App verbunden mit ID: <code>${targetId}</code>`;
          renderButtons();
        }
      };

      function renderButtons() {
        for (let i = 0; i <= 6; i++) {
          const btn = document.createElement("button");
          btn.textContent = `Level ${i}`;
          btn.onclick = () => sendStrength(i);
          buttonsDiv.appendChild(btn);
        }
      }
    </script>
  </body>
</html>
